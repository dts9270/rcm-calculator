<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§µ‡§∞‡•ç‡§∑ 2026 (Action Mode)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #000080; --saffron: #FF9933; --green: #138808; --bg-light: #f4f6f8; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #FF9933 0%, #ffffff 50%, #138808 100%); min-height: 100vh; padding-bottom: 70px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .app-header { background: white; padding: 15px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 0 0 20px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .header-title { font-weight: 800; color: var(--primary); text-transform: uppercase; font-size: 1.1rem; }

        /* TOP STATS */
        .top-stats-container { padding: 15px 20px; display: flex; gap: 15px; justify-content: center; }
        
        .today-circle {
            width: 100px; height: 100px; 
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; cursor: pointer; box-shadow: 0 8px 15px rgba(255, 75, 43, 0.4);
            border: 3px solid white; transition: transform 0.2s;
        }
        .today-circle:active { transform: scale(0.95); }
        .circle-count { font-size: 32px; font-weight: 800; line-height: 1; }
        .circle-label { font-size: 10px; font-weight: 700; text-transform: uppercase; }

        .upcoming-card {
            flex: 1; height: 100px;
            background: linear-gradient(135deg, #56CCF2, #2F80ED);
            border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; cursor: pointer; box-shadow: 0 8px 15px rgba(47, 128, 237, 0.3);
            border: 3px solid white; transition: transform 0.2s;
        }
        .upcoming-card:active { transform: scale(0.95); }
        .up-count { font-size: 32px; font-weight: 800; line-height: 1; }
        .up-label { font-size: 12px; font-weight: 600; }

        /* DASHBOARD GRID */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px 20px; }
        .dash-card { background: white; border-radius: 16px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1); height: 110px; transition: transform 0.2s; border: 2px solid white; cursor: pointer; }
        .dash-card:active { transform: scale(0.95); background: #f0f0f0; }
        .dash-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 8px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .icon-planner { background: linear-gradient(135deg, #667eea, #764ba2); }
        .icon-list { background: linear-gradient(135deg, #FF9966, #FF5E62); }
        .icon-follow { background: linear-gradient(135deg, #56CCF2, #2F80ED); }
        .icon-sales { background: linear-gradient(135deg, #11998e, #38ef7d); }
        .icon-report { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
        .dash-label { font-weight: 700; color: #333; font-size: 12px; text-align: center; }

        /* SECTIONS & TABS */
        .page-section { display: none; padding: 15px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .custom-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .project-tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; scrollbar-width: none; }
        .project-tab-btn { background: white; border: 1px solid #ddd; padding: 8px 20px; border-radius: 50px; font-weight: 600; font-size: 13px; white-space: nowrap; transition: 0.3s; }
        .project-tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); }
        .form-control, .form-select { padding: 10px; border-radius: 8px; }
        .btn-action { width: 100%; padding: 10px; border-radius: 10px; font-weight: bold; color: white; border: none; }
        .back-btn { background: none; border: none; font-size: 22px; color: var(--primary); margin-right: 15px; }
        .list-item { background: white; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--primary); }
        
        /* CALENDAR */
        .planner-card { background: white; border-radius: 20px; padding: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 14px; }
        .cal-day { padding: 8px 0; border-radius: 50%; cursor: pointer; }
        .cal-day:hover { background-color: #f0f0f0; }
        .cal-today { background-color: var(--saffron); color: white; font-weight: bold; }
        .cal-event { border: 2px solid var(--primary); font-weight: bold; color: var(--primary); }
        .meeting-item { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; cursor: pointer; }
        .status-Pending { border-left-color: #ffc107; background-color: #fffbeb; }
        .status-Postponed { border-left-color: #dc3545; background-color: #fff5f5; }
        .status-Done { border-left-color: #198754; background-color: #f0fdf4; opacity: 0.6; }
        .prospect-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); }
        .search-box { border-radius: 30px; border: 2px solid var(--primary); padding: 10px 20px; }
        
        /* MODAL LIST & ACTIONS */
        .task-list-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .task-list-item:last-child { border-bottom: none; }
        .task-actions { margin-top: 8px; display: flex; gap: 10px; }
        .reschedule-box { margin-top: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <b class="mt-3">Connecting...</b>
</div>

<header class="app-header">
    <div class="d-flex align-items-center">
        <button id="backBtn" class="back-btn" onclick="goHome()" style="display:none;"><i class="fas fa-arrow-left"></i></button>
        <div>
            <div class="header-title">‡§ï‡•ç‡§∞‡§æ‡§Ç‡§§‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§µ‡§∞‡•ç‡§∑ 2026</div>
            <div style="font-size: 10px; font-weight: 600; color: #666;">Deepak Shengule | Mission</div>
        </div>
    </div>
    <span class="badge bg-light text-dark border px-2 py-1" id="statusBadge">Checking...</span>
</header>

<div id="homeSection">
    <div class="container mt-3">
        <div class="custom-card p-3 text-center mb-0 bg-light border">
            <h5 class="fw-bold text-primary mb-0" id="currentDateDisplay"></h5>
            <small class="text-muted">Welcome Back!</small>
        </div>
    </div>

    <div class="top-stats-container">
        <div class="today-circle" onclick="openTaskModal('today')">
            <div class="circle-count" id="todayTaskCount">0</div>
            <div class="circle-label">Today</div>
        </div>
        <div class="upcoming-card" onclick="openTaskModal('upcoming')">
            <div class="up-count" id="upcomingTaskCount">0</div>
            <div class="up-label">‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§ï‡§æ‡§Æ‡•á<br>(Upcoming)</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dash-card" onclick="openSection('planner')" style="grid-column: span 2;">
            <div class="dash-icon icon-planner"><i class="fas fa-calendar-alt"></i></div>
            <div class="dash-label">Planner & Meetings</div>
        </div>
        <div class="dash-card" onclick="openSection('list')">
            <div class="dash-icon icon-list"><i class="fas fa-user-plus"></i></div>
            <div class="dash-label">Prospect List</div>
        </div>
        <div class="dash-card" onclick="openSection('followup')">
            <div class="dash-icon icon-follow"><i class="fas fa-phone-volume"></i></div>
            <div class="dash-label">Follow Up</div>
        </div>
        <div class="dash-card" onclick="openSection('sales')">
            <div class="dash-icon icon-sales"><i class="fas fa-hand-holding-usd"></i></div>
            <div class="dash-label">Finance/Sales</div>
        </div>
        <div class="dash-card" onclick="openSection('reports')">
            <div class="dash-icon icon-report"><i class="fas fa-file-download"></i></div>
            <div class="dash-label">Reports</div>
        </div>
    </div>
</div>

<div id="plannerSection" class="page-section">
    <div class="planner-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="m-0 fw-bold text-primary">üóìÔ∏è Monthly Planner</h6>
            <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="openMeetingModal()">+ Add</button>
        </div>
        <div class="text-center fw-bold mb-2" id="calMonthYear"></div>
        <div class="cal-grid mb-2">
            <div class="text-muted small">S</div><div class="text-muted small">M</div><div class="text-muted small">T</div><div class="text-muted small">W</div><div class="text-muted small">T</div><div class="text-muted small">F</div><div class="text-muted small">S</div>
        </div>
        <div class="cal-grid" id="calendarGrid"></div>
        <hr>
        <h6 class="fw-bold text-muted small">UPCOMING MEETINGS:</h6>
        <div id="plannerMeetingList" class="mt-2"></div>
    </div>
</div>

<div id="listSection" class="page-section">
    <div class="project-tabs">
        <button class="project-tab-btn active" onclick="switchProject('health')">‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('anemia')">‡•≤‡§®‡§ø‡§Æ‡§ø‡§Ø‡§æ</button>
        <button class="project-tab-btn" onclick="switchProject('water')">‡§ú‡§≤‡§∏‡§Ç‡§ö‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('network')">‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï</button>
    </div>
    <div class="mb-3"><input type="text" id="searchBox" class="form-control search-box" placeholder="üîç Search Name..." onkeyup="renderCurrentView()"></div>
    <div class="custom-card">
        <h6 class="fw-bold text-primary mb-3">‡§®‡§µ‡•Ä‡§® ‡§Æ‡•á‡§Ç‡§¨‡§∞</h6>
        <div class="bg-light p-2 rounded mb-3 border">
            <button class="btn btn-warning w-100 btn-sm fw-bold text-white mb-2" onclick="pickContact()"><i class="fas fa-address-book"></i> Import</button>
            <select id="importSelect" class="form-select form-select-sm" onchange="fillFromImport()"><option value="">-- Smart Import --</option></select>
        </div>
        <div class="mb-2"><label class="form-label">‡§®‡§æ‡§µ</label><input type="text" id="pName" class="form-control" placeholder="Name"></div>
        <div class="row g-2 mb-2">
            <div class="col-6"><label class="form-label">‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤</label><input type="number" id="pMobile" class="form-control" placeholder="Mobile"></div>
            <div class="col-6"><label class="form-label">‡§ó‡§æ‡§µ</label><input type="text" id="pVillage" class="form-control" placeholder="Village"></div>
        </div>
        <div class="row g-2 mb-3">
            <div class="col-6"><label class="form-label">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø</label><input type="text" id="pProfession" class="form-control" placeholder="Job"></div>
            <div class="col-6"><label class="form-label">‡§™‡•ç‡§∞‡§™‡•ã‡§ú‡§∞</label><input type="text" id="pProposer" class="form-control" placeholder="Ref By"></div>
        </div>
        <button id="saveBtn" class="btn-action" style="background:var(--primary)" onclick="addPerson()">SAVE DATA</button>
    </div>
    <div class="d-flex justify-content-between px-2 mb-2"><span class="fw-bold text-muted">Total: <span id="listCount" class="text-primary">0</span></span></div>
    <div id="personListContainer" style="padding-bottom: 20px;"></div>
</div>

<div id="followupSection" class="page-section">
    <div class="project-tabs">
        <button class="project-tab-btn active" onclick="switchProject('health')">‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('anemia')">‡•≤‡§®‡§ø‡§Æ‡§ø‡§Ø‡§æ</button>
        <button class="project-tab-btn" onclick="switchProject('water')">‡§ú‡§≤‡§∏‡§Ç‡§ö‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('network')">‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï</button>
    </div>
    <div class="custom-card">
        <h6 class="fw-bold text-warning mb-3">‡§´‡•â‡§≤‡•ã-‡§Ö‡§™ ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</h6>
        <label class="form-label">‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡•Ä ‡§®‡§ø‡§µ‡§°‡§æ:</label><select id="followupPersonSelect" class="form-select mb-3"></select>
        <label class="form-label">‡§ö‡§∞‡•ç‡§ö‡§æ:</label><input type="text" id="fRemark" class="form-control mb-3" placeholder="Remark">
        <label class="form-label">‡§™‡•Å‡§¢‡•Ä‡§≤ ‡•© ‡§§‡§æ‡§∞‡§ñ‡§æ:</label>
        <div class="d-flex gap-2 mb-3"><input type="date" id="fDate1" class="form-control"><input type="date" id="fDate2" class="form-control"><input type="date" id="fDate3" class="form-control"></div>
        <button class="btn-action" style="background:var(--saffron)" onclick="addFollowup()">SAVE REMINDER</button>
    </div>
    <div id="followupHistoryList"></div>
</div>

<div id="salesSection" class="page-section">
    <div class="project-tabs">
        <button class="project-tab-btn active" onclick="switchProject('health')">‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('anemia')">‡•≤‡§®‡§ø‡§Æ‡§ø‡§Ø‡§æ</button>
        <button class="project-tab-btn" onclick="switchProject('water')">‡§ú‡§≤‡§∏‡§Ç‡§ö‡§Ø</button>
        <button class="project-tab-btn" onclick="switchProject('network')">‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï</button>
    </div>
    <div class="custom-card">
        <h6 class="fw-bold text-success mb-3">‡§®‡§µ‡•Ä‡§® ‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä (Invoice)</h6>
        <label class="form-label">‡§ó‡•ç‡§∞‡§æ‡§π‡§ï:</label><select id="salePersonSelect" class="form-select mb-3"></select>
        <label class="form-label">‡§™‡•ç‡§∞‡•â‡§°‡§ï‡•ç‡§ü:</label>
        <select id="productSelect" class="form-select mb-3">
            <option value="none">-- Select --</option>
            <option value="‡§∞‡§æ‡§à‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§® ‡§§‡•á‡§≤ 5 ‡§≤‡§ø‡§ü‡§∞">‡§∞‡§æ‡§à‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§® ‡§§‡•á‡§≤ 5L</option><option value="‡§®‡•ç‡§Ø‡•Ç‡§ü‡•ç‡§∞‡§ø‡§≤‡§æ‡§á‡§ü">‡§®‡•ç‡§Ø‡•Ç‡§ü‡•ç‡§∞‡§ø‡§≤‡§æ‡§á‡§ü</option><option value="nutricharge woman">Nutricharge Woman</option><option value="Other">Other</option>
        </select>
        <label class="form-label">‡§§‡§æ‡§∞‡•Ä‡§ñ:</label><input type="date" id="saleDate" class="form-control mb-3">
        <button class="btn-action" style="background:var(--green)" onclick="addSale()">SALE ENTRY</button>
    </div>
    <div id="salesList"></div>
</div>

<div id="reportsSection" class="page-section">
    <ul class="nav nav-pills mb-3 justify-content-center" id="reportTabs">
        <li class="nav-item"><button class="nav-link active" onclick="showReportTab('consolidated')">üìä Consolidated</button></li>
        <li class="nav-item"><button class="nav-link" onclick="showReportTab('segment')">üìë Segment</button></li>
        <li class="nav-item"><button class="nav-link" onclick="showReportTab('meetings')">üóìÔ∏è Meetings</button></li>
    </ul>
    <div id="tab-consolidated">
        <div class="row g-2 mb-3">
            <div class="col-6"><div class="stat-card bg-total"><div class="stat-num" id="repTotalMem">0</div><div class="stat-label">Members</div></div></div>
            <div class="col-6"><div class="stat-card bg-sales"><div class="stat-num" id="repTotalSale">0</div><div class="stat-label">Sales</div></div></div>
        </div>
        <div class="custom-card text-center py-3 mb-3 border-warning">
            <h6 class="mb-2 text-warning"><i class="fas fa-shield-alt"></i> Data Backup</h6>
            <button class="btn btn-sm btn-dark me-2" onclick="backupAllData()">Download</button>
            <button class="btn btn-sm btn-outline-dark" onclick="document.getElementById('restoreFile').click()">Restore</button>
            <input type="file" id="restoreFile" style="display:none" onchange="restoreBackup(this.files[0])">
        </div>
        <div class="custom-card">
            <h6 class="text-primary fw-bold mb-3">Master Summary</h6>
            <div class="table-responsive"><table class="table table-sm table-bordered" id="fullTableConsolidated"><thead class="table-light"><tr><th>Name</th><th>Project</th><th>Village</th><th>Sales</th></tr></thead><tbody id="tblConsolidated"></tbody></table></div>
            <div class="d-flex justify-content-center gap-2 mt-3"><button class="btn btn-sm btn-success" onclick="downloadExcel('consolidated')">Excel</button><button class="btn btn-sm btn-danger" onclick="downloadPDF('consolidated')">PDF</button></div>
        </div>
    </div>
    <div id="tab-segment" style="display:none;">
        <select id="reportSegmentSelect" class="form-select mb-3" onchange="renderSegmentReport()"><option value="health">‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®</option><option value="anemia">‡•≤‡§®‡§ø‡§Æ‡§ø‡§Ø‡§æ ‡§Æ‡•Å‡§ï‡•ç‡§§</option><option value="water">‡§ú‡§≤‡§∏‡§Ç‡§ö‡§Ø</option><option value="network">‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï</option></select>
        <div class="custom-card">
            <div class="table-responsive"><table class="table table-sm table-striped" id="fullTableSegment"><thead><tr><th>Name</th><th>Mobile</th><th>Village</th><th>Ref</th></tr></thead><tbody id="tblSegment"></tbody></table></div>
            <div class="d-flex justify-content-center gap-2 mt-3"><button class="btn btn-sm btn-success" onclick="downloadExcel('segment')">Excel</button><button class="btn btn-sm btn-danger" onclick="downloadPDF('segment')">PDF</button></div>
        </div>
    </div>
    <div id="tab-meetings" style="display:none;">
        <div class="custom-card">
            <div class="table-responsive"><table class="table table-sm table-bordered" id="fullTableMeetings"><thead><tr><th>Date</th><th>Title</th><th>Status</th><th>Remark</th></tr></thead><tbody id="tblMeetings"></tbody></table></div>
            <div class="d-flex justify-content-center gap-2 mt-3"><button class="btn btn-sm btn-success" onclick="downloadExcel('meetings')">Excel</button><button class="btn btn-sm btn-danger" onclick="downloadPDF('meetings')">PDF</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="meetingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title">üóìÔ∏è Meeting Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="meetId">
        <label>Title:</label><input type="text" id="meetTitle" class="form-control mb-2">
        <label>Date:</label><input type="date" id="meetDate" class="form-control mb-2">
        <label>Time:</label><input type="time" id="meetTime" class="form-control mb-2">
        <label>Status:</label><select id="meetStatus" class="form-select mb-2"><option value="Pending">Pending</option><option value="Done">Done</option><option value="Postponed">Postponed</option></select>
        <label>Remark:</label><textarea id="meetRemark" class="form-control mb-2"></textarea>
        <button class="btn btn-primary w-100" onclick="saveMeeting()">Save</button>
        <button class="btn btn-danger w-100 mt-2" onclick="deleteMeeting()">Delete</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white"><h5 class="modal-title">üßæ Invoice</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="invoiceContent" style="font-family: monospace;"></div>
      <div class="modal-footer"><button class="btn btn-primary" onclick="printInvoice()">Print</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="taskPopup" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header" id="taskPopupHeader"><h5 class="modal-title text-white">Tasks</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="taskPopupBody" class="modal-list-group"></div>
      <div class="modal-footer justify-content-center"><button class="btn btn-dark btn-sm rounded-pill px-4" data-bs-dismiss="modal">Close</button></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyCny9svhGUs3Ja5OrTHfH5Kqj05GW2S0RE", authDomain: "dsworldcrm.firebaseapp.com", projectId: "dsworldcrm", storageBucket: "dsworldcrm.firebasestorage.app", messagingSenderId: "449729131508", appId: "1:449729131508:web:61cdd1de17b151717c3fa1" };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.firestore();
    const DOC_ID = "mainData"; const COL_NAME = "crm_data"; 

    let db = { meetings: [], currentProject: 'health', projects: { 'health': { title: '‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®', people: [], followups: [], sales: [] }, 'anemia': { title: '‡•≤‡§®‡§ø‡§Æ‡§ø‡§Ø‡§æ ‡§Æ‡•Å‡§ï‡•ç‡§§', people: [], followups: [], sales: [] }, 'water': { title: '‡§ú‡§≤‡§∏‡§Ç‡§ö‡§Ø', people: [], followups: [], sales: [] }, 'network': { title: '‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï', people: [], followups: [], sales: [] } } };
    let editIndex = null;
    let currentView = 'home';
    let globalTodayList = [];
    let globalUpcomingList = [];

    window.onload = function() {
        document.getElementById('saleDate').valueAsDate = new Date();
        document.getElementById('currentDateDisplay').innerText = new Date().toDateString();
        loadFromFirebase();
    };

    function loadFromFirebase() {
        dbRef.collection(COL_NAME).doc(DOC_ID).get().then((doc) => {
            if (doc.exists) { db = doc.data(); if(!db.meetings) db.meetings=[]; } else { saveToFirebase(); }
            updateStatus("Online", "success");
        }).catch(() => { updateStatus("Offline", "danger"); }).finally(() => {
            document.getElementById('loadingOverlay').style.display = 'none';
            calculateTasks(); renderCalendar(); renderMeetingsList();
            if(globalTodayList.length > 0) openTaskModal('today', true);
            updateDailyStats();
        });
    }

    function saveToFirebase() {
        updateStatus("Saving...", "warning");
        dbRef.collection(COL_NAME).doc(DOC_ID).set(db).then(() => {
            updateStatus("Online", "success");
            if(currentView==='home') calculateTasks();
            else if(currentView === 'planner') { renderCalendar(); renderMeetingsList(); } 
            else if(currentView === 'reports') { renderAllReports(); } 
            else if(currentView !== 'home') renderCurrentView();
            updateDailyStats();
        }).catch(() => updateStatus("Error", "danger"));
    }
    function updateStatus(msg, type) { const b = document.getElementById('statusBadge'); b.innerText = msg; b.className = `badge bg-${type} text-${type==='warning'?'dark':'white'} border px-2 py-1`; }

    // --- TASK LOGIC (UPDATED) ---
    function calculateTasks() {
        const today = new Date().toISOString().split('T')[0];
        globalTodayList = []; globalUpcomingList = [];

        // MEETINGS
        db.meetings.forEach(m => {
            if(m.status === 'Done') return;
            let item = { id: m.id, type: 'MEET', title: m.title, sub: m.remark || '', date: m.date, time: m.time, mobile: '' };
            if(m.date === today) globalTodayList.push(item);
            else if(m.date > today) globalUpcomingList.push(item);
        });

        // FOLLOWUPS
        for(let k in db.projects) {
            db.projects[k].followups.forEach((f, idx) => {
                f.dates.forEach(d => {
                    let item = { id: idx, pKey: k, type: 'CALL', title: f.personName, sub: f.remark, date: d, time: '', mobile: f.mobile };
                    if(d === today) globalTodayList.push(item);
                    else if(d > today) globalUpcomingList.push(item);
                });
            });
        }

        document.getElementById('todayTaskCount').innerText = globalTodayList.length;
        document.getElementById('upcomingTaskCount').innerText = globalUpcomingList.length;
    }

    function openTaskModal(type, auto) {
        const list = type === 'today' ? globalTodayList : globalUpcomingList;
        const header = document.getElementById('taskPopupHeader');
        header.className = type === 'today' ? 'modal-header bg-danger' : 'modal-header bg-primary';
        header.innerHTML = `<h5 class="modal-title text-white">${type==='today'?'üîî ‡§Ü‡§ú‡§ö‡•Ä ‡§ï‡§æ‡§Æ‡•á (Today)':'üìÖ ‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§ï‡§æ‡§Æ‡•á (Upcoming)'}</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>`;
        
        if(list.length === 0) { if(!auto) alert("‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§™‡•á‡§Ç‡§°‡§ø‡§Ç‡§ó ‡§®‡§æ‡§π‡•Ä! üéâ"); return; }

        let html = '<ul class="list-group">';
        list.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
            // Unique ID for reschedule box
            const uid = t.type + '-' + t.id + (t.type==='CALL' ? '-'+t.pKey : ''); 
            
            html += `
            <li class="task-list-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge ${t.type==='MEET'?'bg-primary':'bg-warning text-dark'}">${t.type==='MEET'?'MEETING':'CALL'}</span> 
                        <strong> ${t.title}</strong><br>
                        <small class="text-muted">${t.date} | ${t.sub}</small>
                    </div>
                    ${t.mobile ? `<a href="tel:${t.mobile}" class="btn btn-sm btn-outline-success rounded-circle"><i class="fas fa-phone"></i></a>` : ''}
                </div>
                
                <div class="task-actions">
                    <button class="btn btn-sm btn-success flex-fill" onclick="markTaskDone('${t.type}', '${t.id}', '${t.pKey||''}', '${t.date}')"><i class="fas fa-check"></i> Done</button>
                    <button class="btn btn-sm btn-primary flex-fill" onclick="document.getElementById('resch-${uid}').style.display='block'"><i class="fas fa-calendar-alt"></i> Next</button>
                </div>

                <div id="resch-${uid}" class="reschedule-box">
                    <div class="input-group input-group-sm">
                        <input type="date" id="date-${uid}" class="form-control">
                        <button class="btn btn-primary" onclick="rescheduleTask('${t.type}', '${t.id}', '${t.pKey||''}', '${t.date}', 'date-${uid}')">Save</button>
                    </div>
                </div>
            </li>`;
        });
        html += '</ul>';
        document.getElementById('taskPopupBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('taskPopup')).show();
    }

    // --- ACTIONS: DONE & RESCHEDULE ---
    window.markTaskDone = function(type, id, pKey, date) {
        if(type === 'MEET') {
            const m = db.meetings.find(x => String(x.id) === String(id));
            if(m) m.status = 'Done';
        } else {
            // Remove specific date from followup
            const f = db.projects[pKey].followups[id];
            if(f) f.dates = f.dates.filter(d => d !== date);
        }
        saveToFirebase();
        bootstrap.Modal.getInstance(document.getElementById('taskPopup')).hide();
    }

    window.rescheduleTask = function(type, id, pKey, oldDate, inputId) {
        const newDate = document.getElementById(inputId).value;
        if(!newDate) return alert("Select Date");

        if(type === 'MEET') {
            const m = db.meetings.find(x => String(x.id) === String(id));
            if(m) { m.date = newDate; m.status = 'Postponed'; }
        } else {
            const f = db.projects[pKey].followups[id];
            if(f) {
                f.dates = f.dates.filter(d => d !== oldDate); // Remove old
                f.dates.push(newDate); // Add new
            }
        }
        saveToFirebase();
        bootstrap.Modal.getInstance(document.getElementById('taskPopup')).hide();
    }

    // --- NAVIGATION & VIEWS ---
    window.openSection = function(sec) {
        currentView = sec;
        document.getElementById('homeSection').style.display = 'none';
        document.getElementById('backBtn').style.display = 'block';
        ['listSection', 'followupSection', 'salesSection', 'reportsSection', 'plannerSection'].forEach(id => document.getElementById(id).style.display = 'none');
        if(sec === 'planner') { document.getElementById('plannerSection').style.display = 'block'; renderCalendar(); renderMeetingsList(); }
        else if(sec === 'reports') { document.getElementById('reportsSection').style.display = 'block'; renderAllReports(); }
        else { document.getElementById(sec + 'Section').style.display = 'block'; renderCurrentView(); }
    }
    window.goHome = function() {
        currentView = 'home';
        ['listSection', 'followupSection', 'salesSection', 'reportsSection', 'plannerSection'].forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('homeSection').style.display = 'block';
        document.getElementById('backBtn').style.display = 'none';
        calculateTasks();
    }
    window.switchProject = function(key) {
        db.currentProject = key;
        const map = {'health':0,'anemia':1,'water':2,'network':3};
        document.querySelectorAll('.project-tabs').forEach(grp => {
            Array.from(grp.children).forEach(b => b.classList.remove('active'));
            grp.children[map[key]].classList.add('active');
        });
        renderCurrentView();
    }

    // --- RENDER VIEWS ---
    function renderCurrentView() {
        if(currentView === 'home' || currentView === 'reports' || currentView === 'planner') return;
        const proj = db.projects[db.currentProject];
        
        if(currentView === 'list') {
            document.getElementById('listCount').innerText = proj.people.length;
            const container = document.getElementById('personListContainer'); container.innerHTML = '';
            const searchVal = document.getElementById('searchBox').value.toLowerCase();
            proj.people.map((p,i)=>({...p, oIdx:i})).reverse().forEach(p => {
                if(p.name.toLowerCase().includes(searchVal) || String(p.mobile).includes(searchVal)) {
                    container.innerHTML += `
                    <div class="prospect-card">
                        <div style="display:flex;align-items:center;margin-bottom:10px;">
                            <div style="width:45px;height:45px;background:#eee;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#555;margin-right:15px;">${p.name.charAt(0)}</div>
                            <div><h6 style="margin:0;font-weight:bold;">${p.name}</h6><small>${p.village} | ${p.mobile}</small></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;border-top:1px solid #eee;padding-top:10px;">
                            <a href="tel:${p.mobile}" class="btn btn-sm btn-success flex-fill me-1"><i class="fas fa-phone"></i> Call</a>
                            <a href="https://wa.me/91${p.mobile}" class="btn btn-sm btn-success flex-fill me-1"><i class="fab fa-whatsapp"></i> WA</a>
                            <button class="btn btn-sm btn-warning me-1" onclick="editPerson(${p.oIdx})"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="delPerson(${p.oIdx})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }
            });
            loadImportOptions();
        }
        if(currentView === 'followup') {
            const sel = document.getElementById('followupPersonSelect'); sel.innerHTML='<option value="">Select</option>';
            proj.people.forEach((p,i)=> sel.innerHTML+=`<option value="${i}">${p.name}</option>`);
            const h = document.getElementById('followupHistoryList'); h.innerHTML='';
            proj.followups.slice().reverse().forEach(f => {
                h.innerHTML+=`<div class="list-item" style="border-left-color:var(--saffron)"><div><h6>${f.personName}</h6><small>${f.remark}</small></div><small class="text-muted">${f.entryDate}</small></div>`;
            });
        }
        if(currentView === 'sales') {
            const sel = document.getElementById('salePersonSelect'); sel.innerHTML='<option value="">Select</option>';
            proj.people.forEach((p,i)=> sel.innerHTML+=`<option value="${i}">${p.name}</option>`);
            const h = document.getElementById('salesList'); h.innerHTML='';
            proj.sales.slice().reverse().forEach(s => {
                h.innerHTML+=`<div class="list-item" style="border-left-color:var(--green)"><div><h6>${s.personName}</h6><small>${s.product}</small></div><div><small class="d-block text-end">${s.date}</small><button class="btn btn-sm btn-outline-dark py-0" onclick='generateInvoice(${JSON.stringify(s)})'>üßæ</button></div></div>`;
            });
        }
    }

    // --- PRO FEATURES ---
    function generateInvoice(sale) { document.getElementById('invoiceContent').innerHTML = `<div style="text-align:center; padding:10px;"><h3>INVOICE</h3><hr><p><b>Customer:</b> ${sale.personName}</p><p><b>Item:</b> ${sale.product}</p><p><b>Date:</b> ${sale.date}</p><hr><p>Thank you!</p></div>`; new bootstrap.Modal(document.getElementById('invoiceModal')).show(); }
    function printInvoice() { const c = document.getElementById('invoiceContent').innerHTML; const w = window.open(); w.document.write(c); w.print(); w.close(); }
    window.backupAllData = function() { const blob = new Blob([JSON.stringify(db)], {type: "application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Mission2026_Backup.json"; a.click(); }
    window.restoreBackup = function(file) { const reader = new FileReader(); reader.onload = e => { db = JSON.parse(e.target.result); saveToFirebase(); alert("Restored!"); location.reload(); }; reader.readAsText(file); }

    // --- ACTIONS ---
    window.addPerson = function() { const p = {name:document.getElementById('pName').value, mobile:document.getElementById('pMobile').value, village:document.getElementById('pVillage').value, profession:document.getElementById('pProfession').value, proposer:document.getElementById('pProposer').value}; if(!p.name || !p.mobile) return alert("Required"); if(editIndex!==null) db.projects[db.currentProject].people[editIndex]=p; else db.projects[db.currentProject].people.push(p); saveToFirebase(); resetForm(); }
    window.editPerson = function(idx) { const p = db.projects[db.currentProject].people[idx]; document.getElementById('pName').value=p.name; document.getElementById('pMobile').value=p.mobile; document.getElementById('pVillage').value=p.village; document.getElementById('pProfession').value=p.profession; document.getElementById('pProposer').value=p.proposer; editIndex=idx; document.getElementById('saveBtn').innerText="UPDATE"; window.scrollTo(0,0); }
    function resetForm(){ ['pName','pMobile','pVillage','pProfession','pProposer'].forEach(id=>document.getElementById(id).value=''); editIndex=null; document.getElementById('saveBtn').innerText="SAVE DATA"; }
    window.delPerson = function(idx) { if(confirm("Del?")) { db.projects[db.currentProject].people.splice(idx,1); saveToFirebase(); }}
    function loadImportOptions() { const sel = document.getElementById('importSelect'); sel.innerHTML='<option>Smart Import</option>'; const cur = db.projects[db.currentProject].people.map(p=>String(p.mobile)); for(let k in db.projects) { if(k===db.currentProject) continue; db.projects[k].people.forEach(p=>{ if(!cur.includes(String(p.mobile))) sel.innerHTML+=`<option value='${JSON.stringify(p)}'>${p.name} (${db.projects[k].title})</option>`; }); } }
    window.fillFromImport = function() { const v = document.getElementById('importSelect').value; if(v && v.includes('{')) { const p=JSON.parse(v); document.getElementById('pName').value=p.name; document.getElementById('pMobile').value=p.mobile; document.getElementById('pVillage').value=p.village; } }
    window.addFollowup = function() { const i=document.getElementById('followupPersonSelect').value; if(i==="")return; const p=db.projects[db.currentProject].people[i]; let dates=[]; ['fDate1','fDate2','fDate3'].forEach(d=>{if(document.getElementById(d).value)dates.push(document.getElementById(d).value)}); db.projects[db.currentProject].followups.push({personName:p.name,mobile:p.mobile,remark:document.getElementById('fRemark').value,dates:dates,entryDate:new Date().toISOString().split('T')[0]}); saveToFirebase(); alert("Saved"); }
    window.addSale = function() { const i=document.getElementById('salePersonSelect').value; if(i==="")return; const p=db.projects[db.currentProject].people[i]; const pr=document.getElementById('productSelect').value; db.projects[db.currentProject].sales.push({personName:p.name,product:pr,date:document.getElementById('saleDate').value}); saveToFirebase(); alert("Saved"); }
    
    // --- MEETINGS ---
    function renderCalendar() { const g=document.getElementById('calendarGrid'); const n=new Date(); document.getElementById('calMonthYear').innerText=n.toLocaleString('default',{month:'long'})+" "+n.getFullYear(); let h=''; ['S','M','T','W','T','F','S'].forEach(d=>h+=`<b>${d}</b>`); for(let i=1;i<=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();i++){ let d=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; let cls=db.meetings.some(m=>m.date===d)?'cal-event':(i===n.getDate()?'cal-today':'cal-day'); h+=`<div class="${cls}" onclick="openMeetingModal(null,'${d}')">${i}</div>`; } g.innerHTML=h; }
    function renderMeetingsList() { const l=document.getElementById('plannerMeetingList'); l.innerHTML=''; const sorted=db.meetings.sort((a,b)=> {const m={'Pending':1,'Postponed':2,'Done':3}; return (m[a.status]||4)-(m[b.status]||4)}); sorted.forEach(m=>{ let st=`status-${m.status||'Pending'}`; l.innerHTML+=`<div class="meeting-item ${st} d-flex justify-content-between align-items-center"><div onclick='openMeetingModal(${JSON.stringify(m)})' style="flex-grow:1"><div class="d-flex justify-content-between"><strong>${m.title}</strong><span class="badge bg-secondary" style="font-size:10px">${m.status}</span></div><small>${m.date} ${m.time||''} | ${m.remark||''}</small></div><button class="btn btn-sm text-danger ms-2" onclick="deleteMeetingDirect(${m.id})"><i class="fas fa-trash"></i></button></div>`; }); }
    function openMeetingModal(m,d) { if(m){document.getElementById('meetId').value=m.id; document.getElementById('meetTitle').value=m.title; document.getElementById('meetDate').value=m.date; document.getElementById('meetTime').value=m.time; document.getElementById('meetStatus').value=m.status; document.getElementById('meetRemark').value=m.remark;} else { document.getElementById('meetId').value=''; document.getElementById('meetTitle').value=''; document.getElementById('meetDate').value=d||''; } new bootstrap.Modal(document.getElementById('meetingModal')).show(); }
    function saveMeeting() { const id=document.getElementById('meetId').value; const obj={id:id?id:Date.now(),title:document.getElementById('meetTitle').value,date:document.getElementById('meetDate').value,time:document.getElementById('meetTime').value,status:document.getElementById('meetStatus').value,remark:document.getElementById('meetRemark').value}; if(!obj.title) return alert("Title?"); if(id){const idx=db.meetings.findIndex(m=>m.id==id);if(idx!==-1)db.meetings[idx]=obj;}else{db.meetings.push(obj);} saveToFirebase(); bootstrap.Modal.getInstance(document.getElementById('meetingModal')).hide(); }
    window.deleteMeetingDirect = function(id) { if(confirm("Del?")){db.meetings=db.meetings.filter(m=>m.id!=id); saveToFirebase();} }
    function deleteMeeting() { deleteMeetingDirect(document.getElementById('meetId').value); bootstrap.Modal.getInstance(document.getElementById('meetingModal')).hide(); }

    // --- REPORTS ---
    function renderAllReports() { let tm=0, ts=0, tc=0; let mr=''; for(let k in db.projects){ tm+=db.projects[k].people.length; ts+=db.projects[k].sales.length; tc+=db.projects[k].followups.length; db.projects[k].people.forEach(p=>{ let s=db.projects[k].sales.filter(x=>x.personName===p.name).length; mr+=`<tr><td>${p.name}</td><td>${db.projects[k].title}</td><td>${p.village}</td><td>${s}</td></tr>`; }); } document.getElementById('repTotalMem').innerText=tm; document.getElementById('repTotalSale').innerText=ts; document.getElementById('tblConsolidated').innerHTML=mr; renderSegmentReport(); let mRow=''; db.meetings.forEach(m=>{ mRow+=`<tr><td>${m.date}</td><td>${m.title}</td><td>${m.status}</td><td>${m.remark}</td></tr>`; }); document.getElementById('tblMeetings').innerHTML=mRow; }
    window.showReportTab=function(t){ ['consolidated','segment','meetings'].forEach(x=>document.getElementById('tab-'+x).style.display='none'); document.getElementById('tab-'+t).style.display='block'; renderAllReports(); }
    window.renderSegmentReport=function(){ const k=document.getElementById('reportSegmentSelect').value; const p=db.projects[k]; document.getElementById('segTotalMem').innerText=p.people.length; document.getElementById('segTotalSale').innerText=p.sales.length; let r=''; p.people.forEach(x=> r+=`<tr><td>${x.name}</td><td>${x.mobile}</td><td>${x.village}</td><td>${x.proposer}</td></tr>`); document.getElementById('tblSegment').innerHTML=r; }
    window.downloadExcel=function(t){ const tbl=(t==='meetings')?'fullTableMeetings':(t==='segment'?'fullTableSegment':'fullTableConsolidated'); const wb=XLSX.utils.table_to_book(document.getElementById(tbl),{sheet:"Data"}); XLSX.writeFile(wb, t+"_Report.xlsx"); }
    window.downloadPDF=function(t){ let id=(t==='meetings')?'tab-meetings':(t==='segment'?'tab-segment':'tab-consolidated'); html2pdf().from(document.getElementById(id)).save(); }
    
    function updateDailyStats() { const today=new Date().toISOString().split('T')[0]; let s=0; for(let k in db.projects) s+=db.projects[k].sales.filter(x=>x.date===today).length; if(s>0) document.getElementById('statusBadge').innerText += ` | Today Sales: ${s}`; }
    window.pickContact = async function() { try{const c = await navigator.contacts.select(['name','tel'],{multiple:false}); if(c.length){document.getElementById('pName').value=c[0].name[0]; document.getElementById('pMobile').value=c[0].tel[0];}}catch(e){} }
</script>

</body>
</html>
