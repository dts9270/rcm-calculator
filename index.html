<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DS WORLD ‚Äî PRO MAX Calculator</title>

<!-- Marathi font -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#0a5b99;
  --accent:#0ea44a;
  --muted:#6b7280;
  --bg: linear-gradient(180deg,#f4fbff,#eef5ff);
  --card-bg: rgba(255,255,255,0.7);
  --glass-blur: blur(10px);
  --shadow: 0 10px 30px rgba(12,40,80,0.08);
  --radius:14px;
}
.dark{
  --bg: linear-gradient(180deg,#081018,#07101a);
  --primary:#6fb8ff;
  --accent:#34e18a;
  --card-bg: rgba(20,26,34,0.55);
  --muted:#9aa6b2;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Noto Sans Devanagari", system-ui, sans-serif;
  background:var(--bg);
  color:#0f1724;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition:background .25s, color .25s;
}

/* Container */
.wrap{
  max-width:980px;
  margin:14px auto;
  padding:14px;
}

/* Header */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  background:transparent;
  margin-bottom:12px;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:64px;height:64px;border-radius:12px;background:#fff;display:flex;align-items:center;justify-content:center;
  box-shadow:var(--shadow);
}
.logo img{width:100%;height:100%;object-fit:contain}
.title{font-weight:700;font-size:20px;color:var(--primary)}
.now{font-size:13px;color:var(--muted)}

/* Layout */
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
@media(max-width:920px){.grid{grid-template-columns:1fr}}

/* Card */
.card{
  padding:16px;border-radius:var(--radius);
  background:var(--card-bg);
  border:1px solid rgba(255,255,255,0.4);
  box-shadow:var(--shadow);
  backdrop-filter:var(--glass-blur);
}

/* Controls */
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.field{flex:1}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button{font-family:inherit}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff}
.qty{width:96px}

/* Product list */
#productList{margin-top:12px;max-height:340px;overflow:auto;padding-right:6px}
.product-item{display:flex;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef6ff;margin-bottom:10px}
.product-name{font-weight:700;color:var(--primary)}
.product-meta{font-size:13px;color:var(--muted)}

/* Totals summary */
.totals{margin-top:14px;border-top:1px solid rgba(0,0,0,0.04);padding-top:12px}
.total-row{display:flex;justify-content:space-between;padding:8px 0;font-weight:700}
.total-row .muted{color:var(--muted);font-weight:600}

/* Cards */
.cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.big-card{padding:16px;border-radius:12px;color:#fff;font-weight:800;text-align:center}
.card-saving{background:linear-gradient(135deg,#ff9a3c,#ff6f2d)}
.card-cons{background:linear-gradient(135deg,#8a56ff,#5a34d9)}
.card-annual{background:linear-gradient(135deg,#0ea44a,#058e2b)}
.card-future{background:linear-gradient(135deg,#00b0ff,#0068d6)}

/* Buttons */
.btn{padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--primary)}
.actions{display:flex;gap:10px;flex-direction:column}

/* Floating add */
.fab{position:fixed;right:18px;bottom:20px;width:60px;height:60px;border-radius:999px;background:linear-gradient(135deg,var(--primary),#006fbd);color:#fff;font-size:28px;display:flex;align-items:center;justify-content:center;box-shadow:0 12px 30px rgba(0,0,0,0.18);z-index:999}

/* Popup + confetti */
#overlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.16);z-index:1200}
.popup{background:var(--card-bg);padding:18px;border-radius:12px;text-align:center;box-shadow:var(--shadow)}
.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1250}
.conf{position:absolute;font-size:22px;animation:fly 1.2s ease-out forwards}
@keyframes fly{0%{transform:translateY(0) scale(.8);opacity:1}100%{transform:translateY(-220px) scale(1.2);opacity:0}}

/* Footer */
.footer{margin-top:14px;text-align:center;color:var(--muted);font-weight:700}
</style>
</head>
<body>

<div class="wrap">

  <header class="header">
    <div class="brand">
      <div class="logo"><img src="logo.png" alt="DS" onerror="this.style.display='none'"></div>
      <div>
        <div class="title">DS WORLD ‚Äî PRO MAX</div>
        <div class="now" id="nowDate"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeToggle" class="btn btn-ghost">üåô Dark</button>
      <div style="font-weight:800;color:var(--primary)">7020970727</div>
    </div>
  </header>

  <div class="grid">

    <!-- left: calculator -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;color:var(--primary);font-family:inherit">PRO MAX ‡§ï‡•Ö‡§≤‡§ï‡•ç‡§Ø‡•Å‡§≤‡•á‡§ü‡§∞</h3>
      <div style="color:var(--muted);font-size:13px;margin-bottom:12px">Quantity ‡§¶‡•ç‡§Ø‡§æ ‡§Ü‡§£‡§ø ‡§§‡§æ‡§¨‡§°‡§§‡•ã‡§¨ ‡§´‡§æ‡§Ø‡§¶‡•á ‡§™‡§æ‡§π‡§æ</div>

      <div class="row">
        <div class="field">
          <label>Product ‡§®‡§ø‡§µ‡§°‡§æ</label>
          <select id="productSelect"><option>Loading...</option></select>
        </div>
        <div class="field" style="max-width:110px">
          <label>Quantity</label>
          <input id="qtyInput" type="number" min="1" value="1" class="qty">
        </div>
        <div style="align-self:flex-end">
          <button id="addBtn" class="btn btn-primary">+ Add</button>
        </div>
      </div>

      <div id="productList" style="margin-top:12px">
        <div style="text-align:center;color:var(--muted);padding:18px">‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•Ä ‡§Ü‡§π‡•á. ‡§™‡•ç‡§∞‡•â‡§°‡§ï‡•ç‡§ü ‡§ç‡§° ‡§ï‡§∞‡§æ.</div>
      </div>

      <div class="totals">
        <div class="total-row"><div class="muted">‡§è‡§ï‡•Ç‡§£ Qty</div><div id="totalQty">0</div></div>
        <div class="total-row"><div class="muted">‡§è‡§ï‡•Ç‡§£ Market</div><div id="totalMarket">‚Çπ0</div></div>
        <div class="total-row"><div class="muted">‡§è‡§ï‡•Ç‡§£ RCM</div><div id="totalRCM">‚Çπ0</div></div>
        <div class="total-row"><div class="muted">‡§è‡§ï‡•Ç‡§£ PV</div><div id="totalPV">0</div></div>
      </div>

    </div>

    <!-- right: cards & actions -->
    <div>
      <div class="card">
        <div class="cards-grid">
          <div class="big-card card-saving">
            <div style="font-size:13px">‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§´‡§æ‡§Ø‡§¶‡§æ</div>
            <div id="cardMonthly" style="font-size:22px;margin-top:8px">‚Çπ0</div>
          </div>

          <div class="big-card card-cons">
            <div style="font-size:13px">Consistency</div>
            <div id="cardCons" style="font-size:22px;margin-top:8px">‚Çπ0</div>
          </div>

          <div class="big-card card-annual">
            <div style="font-size:13px">‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§¨‡§ö‡§§</div>
            <div id="cardAnnual" style="font-size:22px;margin-top:8px">‚Çπ0</div>
          </div>

          <div class="big-card card-future">
            <div style="font-size:13px">20 ‡§µ‡§∞‡•ç‡§∑‡•á ‡§¨‡§ö‡§§</div>
            <div id="cardTwenty" style="font-size:22px;margin-top:8px">‚Çπ0</div>
          </div>
        </div>

        <div style="margin-top:12px" class="actions">
          <button id="waBtn" class="btn btn-primary">WhatsApp ‡§µ‡§∞ ‡§™‡§æ‡§†‡§µ‡§æ</button>
          <button id="pdfBtn" class="btn btn-ghost">PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
          <button id="imgBtn" class="btn btn-ghost">Image</button>
          <button id="clearBtn" class="btn btn-ghost">Clear Order</button>
        </div>
      </div>
    </div>

  </div>

  <div class="footer">Designed by DS WORLD üåç</div>
</div>

<!-- overlay popup & confetti -->
<div id="overlay" aria-hidden="true">
  <div class="popup" id="popupBox">‚úî Product added</div>
</div>
<div id="confetti" class="confetti"></div>

<!-- floating add -->
<button class="fab" id="fab">+</button>

<!-- libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
/* ===== PRO MAX FINAL SCRIPT ===== */
const el = id => document.getElementById(id);
const fmt = n => Math.round(n).toLocaleString('en-IN');

el('nowDate').innerText = new Date().toLocaleString('mr-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});

/* Theme toggle */
el('themeToggle').onclick = ()=>{
  document.body.classList.toggle('dark');
  el('themeToggle').innerText = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
};

/* Sheet config */
const SHEET_ID = "1eR5THz-4AV3HkfnNJ5Un48ksz0I0jrepJSED3qHFg6k";
const RAW = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
const SHEET_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(RAW);

/* state */
let products = [];
let order = [];

/* Safe GViz parser */
function parseGvizSafe(text){
  try{
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    const jsonText = text.substring(start, end+1);
    return JSON.parse(jsonText);
  }catch(e){
    console.error('GViz parse failed', e);
    return null;
  }
}

/* Auto-fix loader */
async function loadProducts(){
  try{
    const r = await fetch(SHEET_URL);
    if(!r.ok) throw new Error('Network '+r.status);
    const txt = await r.text();
    const j = parseGvizSafe(txt);
    if(!j || !j.table || !Array.isArray(j.table.rows)) throw new Error('Invalid sheet');
    products = j.table.rows.map(row => ({
      name: row.c[0]?.v || "",
      market: Number(row.c[1]?.v || 0),
      rcm: Number(row.c[2]?.v || 0),
      pv: Number(row.c[3]?.v || 0)
    })).filter(p => p.name && p.name.trim() !== '');
    if(products.length === 0) throw new Error('No products');
    populateDropdown();
    calc();
    console.log('Loaded products:', products.length);
  }catch(err){
    console.warn('Sheet load error', err);
    // fallback
    products = [
      {name:"‡§ü‡§æ‡§ü‡§æ ‡§Æ‡•Ä‡§† 1 ‡§ï‡§ø‡§≤‡•ã",market:30,rcm:20,pv:7},
      {name:"‡§∞‡•á‡§° ‡§≤‡•á‡§¨‡§≤ ‡§ö‡§π‡§æ 500g",market:310,rcm:240,pv:120}
    ];
    populateDropdown();
    calc();
    // don't spam user: show once
    // alert('Google Sheet ‡§≤‡•ã‡§° ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ö‡§°‡§ö‡§£. ‡§´allback products ‡§≤‡•ã‡§° ‡§ï‡•á‡§≤‡•á.');
  }
}

/* populate dropdown */
function populateDropdown(){
  const sel = el('productSelect');
  sel.innerHTML = "<option value=''>-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>";
  products.forEach((p,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = p.name;
    sel.appendChild(o);
  });
}

/* add product */
el('addBtn').onclick = addProduct;
el('fab').onclick = ()=> el('addBtn').click();

function addProduct(){
  const idx = el('productSelect').value;
  if(idx === '') return alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡•â‡§°‡§ï‡•ç‡§ü ‡§®‡§ø‡§µ‡§°‡§æ');
  const qty = Math.max(1, parseInt(el('qtyInput').value) || 1);
  const p = products[Number(idx)];
  const ex = order.find(o=>o.name === p.name);
  if(ex) ex.qty += qty; else order.push({...p, qty});
  showPopup(`${p.name} ‡§ú‡•ã‡§°‡§≤‡•á`);
  spawnConfetti();
  calc();
}

/* calc & render */
function calc(){
  const list = el('productList');
  list.innerHTML = '';
  if(order.length === 0){
    list.innerHTML = `<div style="text-align:center;color:${getComputedStyle(document.body).getPropertyValue('--muted')};padding:18px">‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ë‡§∞‡•ç‡§°‡§∞ ‡§∞‡§ø‡§ï‡§æ‡§Æ‡•Ä ‡§Ü‡§π‡•á. ‡§™‡•ç‡§∞‡•â‡§°‡§ï‡•ç‡§ü ‡§ç‡§° ‡§ï‡§∞‡§æ.</div>`;
  }
  let tQ=0,tM=0,tR=0,tPV=0,tSave=0;
  order.forEach((it, idx)=>{
    const m = it.market * it.qty;
    const r = it.rcm * it.qty;
    const pv = it.pv * it.qty;
    const s = (it.market - it.rcm) * it.qty;
    tQ += it.qty; tM += m; tR += r; tPV += pv; tSave += s;

    const div = document.createElement('div');
    div.className = 'product-item';
    div.innerHTML = `
      <div>
        <div class="product-name">${it.name}</div>
        <div class="product-meta">PV: ${it.pv} ‚Ä¢ M: ‚Çπ${it.market} ‚Ä¢ RCM: ‚Çπ${it.rcm}</div>
      </div>
      <div style="text-align:right">
        <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end;margin-bottom:6px">
          <button class="btn-ghost" data-i="${idx}" data-a="minus">‚àí</button>
          <input class="inline-qty" data-i="${idx}" type="number" value="${it.qty}" min="1" style="width:56px;text-align:center;border-radius:8px;border:1px solid #eee;padding:6px">
          <button class="btn-ghost" data-i="${idx}" data-a="plus">+</button>
        </div>
        <div style="font-weight:800;color:var(--accent)">‚Çπ${fmt(s)}</div>
        <div style="margin-top:6px"><button class="btn btn-ghost" data-i="${idx}" data-a="remove">Remove</button></div>
      </div>
    `;
    list.appendChild(div);
  });

  el('totalQty').innerText = tQ;
  el('totalMarket').innerText = `‚Çπ${fmt(tM)}`;
  el('totalRCM').innerText = `‚Çπ${fmt(tR)}`;
  el('totalPV').innerText = tPV;

  // consistency rule
  let cons = 0;
  if(tPV < 1500) cons = tPV * 0.12;
  else if(tPV < 2500) cons = 1500 * 0.1667;
  else cons = 5000 * 0.1667;

  const monthly = tSave + cons;
  el('cardCons').innerText = `‚Çπ${fmt(Math.round(cons))}`;
  el('cardMonthly').innerText = `‚Çπ${fmt(Math.round(monthly))}`;
  el('cardAnnual').innerText = `‚Çπ${fmt(Math.round(monthly*12))}`;
  el('cardTwenty').innerText = `‚Çπ${fmt(Math.round(monthly*12*20))}`;

  // attach handlers
  document.querySelectorAll('.btn-ghost').forEach(b=>{
    b.onclick = ()=>{
      const i = Number(b.dataset.i);
      const a = b.dataset.a;
      if(a === 'plus') order[i].qty++;
      else if(a === 'minus'){ order[i].qty = Math.max(1, order[i].qty - 1); }
      else if(a === 'remove'){ order.splice(i,1); }
      calc();
    };
  });
  document.querySelectorAll('.inline-qty').forEach(inp=>{
    inp.onchange = ()=>{
      const i = Number(inp.dataset.i);
      order[i].qty = Math.max(1, parseInt(inp.value) || 1);
      calc();
    };
  });
}

/* popup */
function showPopup(text){
  const o = el('overlay');
  const p = el('popupBox');
  p.innerText = '‚úî ' + text;
  o.style.display = 'flex';
  setTimeout(()=> o.style.display = 'none', 1300);
}

/* confetti */
function spawnConfetti(){
  const box = el('confetti');
  const emojis = ['üéâ','‚ú®','üí∞','üéä','‚≠ê'];
  for(let i=0;i<12;i++){
    const d = document.createElement('div');
    d.className = 'conf';
    d.style.left = (10 + Math.random()*80) + '%';
    d.style.top = (60 + Math.random()*25) + '%';
    d.innerText = emojis[Math.floor(Math.random()*emojis.length)];
    box.appendChild(d);
    setTimeout(()=> d.remove(), 1200);
  }
}

/* clear */
el('clearBtn').onclick = ()=> {
  if(order.length === 0) return;
  if(confirm('Clear order?')){ order = []; calc(); }
};

/* WhatsApp share */
el('waBtn').onclick = ()=> {
  if(order.length === 0) return alert('‡§ï‡§æ‡§π‡•Ä ‡§Ü‡§Ø‡§ü‡§Æ ‡§®‡§æ‡§π‡•Ä‡§§');
  let msg = `*RCM Order Summary*%0A%0A`;
  order.forEach((p,i)=> msg += `${i+1}. ${p.name} √ó ${p.qty}%0A`);
  msg += `%0ATotal PV: ${el('totalPV').innerText}%0ABenefit: ${el('cardMonthly').innerText}`;
  window.open('https://wa.me/?text=' + encodeURIComponent(msg));
};

/* Image export */
el('imgBtn').onclick = ()=>{
  html2canvas(document.querySelector('.wrap')).then(canvas=>{
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'PRO_MAX_Order.png';
    a.click();
  });
};

/* PDF invoice */
el('pdfBtn').onclick = ()=>{
  if(order.length === 0) return alert('Order is empty');
  let invoice = `<style>body{font-family:Noto Sans Devanagari, Arial;}</style>`;
  invoice += `<h2 style="color:${getComputedStyle(document.body).getPropertyValue('--primary')};text-align:center">DS WORLD ‚Äî Invoice</h2>`;
  invoice += `<p><b>Customer:</b> ${el('custName')?.value || '-'} | <b>Date:</b> ${new Date().toLocaleDateString('en-GB')}</p>`;
  invoice += `<table style="width:100%;border-collapse:collapse;font-size:13px"><tr><th style="border:1px solid #ddd;padding:8px">#</th><th style="border:1px solid #ddd;padding:8px">Product</th><th style="border:1px solid #ddd;padding:8px">Qty</th><th style="border:1px solid #ddd;padding:8px">PV</th><th style="border:1px solid #ddd;padding:8px">RCM</th></tr>`;
  order.forEach((p,i)=>{
    invoice += `<tr><td style="border:1px solid #ddd;padding:6px">${i+1}</td><td style="border:1px solid #ddd;padding:6px">${p.name}</td><td style="border:1px solid #ddd;padding:6px">${p.qty}</td><td style="border:1px solid #ddd;padding:6px">${p.pv * p.qty}</td><td style="border:1px solid #ddd;padding:6px">‚Çπ${fmt(p.rcm * p.qty)}</td></tr>`;
  });
  invoice += `</table>`;
  html2pdf().from(invoice).set({margin:10, filename:'Invoice.pdf', html2canvas:{scale:1.1}}).save();
};

/* Search filter for dropdown (simple) */
const searchInput = document.createElement('input');
searchInput.placeholder = 'Search product...';
searchInput.style.width = '100%';
searchInput.style.margin = '10px 0';
searchInput.style.padding = '8px';
searchInput.style.borderRadius = '8px';
searchInput.oninput = ()=> {
  const q = searchInput.value.trim().toLowerCase();
  const sel = el('productSelect');
  sel.innerHTML = "<option value=''>-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>";
  products.forEach((p,i)=>{
    if(!q || p.name.toLowerCase().includes(q)) {
      const o = document.createElement('option'); o.value = i; o.textContent = p.name; sel.appendChild(o);
    }
  });
};
document.querySelector('.card').insertBefore(searchInput, document.getElementById('productSelect'));

/* init */
window.addEventListener('load', ()=> {
  loadProducts();
});

/* expose for debugging (optional) */
window._promax = { loadProducts, products, order };
</script>
</body>
</html>
